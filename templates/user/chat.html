{% extends "base.html" %}

{% block title %}Chat - Bodhgriha{% endblock %}

{% block content %}
<div class="relative isolate">
    <div class="absolute inset-0 -z-10">
        <div class="absolute inset-x-0 top-0 h-60 bg-gradient-to-br from-slate-600 via-black to-slate-800 blur-3xl opacity-70"></div>
        <div class="absolute inset-0">
            <img src="{{ url_for('static', filename='images/chat-background.jpeg') }}"
                 alt="Chat backdrop"
                 class="h-full w-full object-cover opacity-90">
        </div>
    </div>

    <div class="container mx-auto px-4 py-12">
        <div class="w-full max-w-5xl mx-auto rounded-3xl border border-white/30 bg-white/30 backdrop-blur-2xl shadow-2xl shadow-emerald-200/40 ring-1 ring-white/40 overflow-hidden">
            <div class="grid md:grid-cols-[260px_1fr]">
                <aside class="hidden md:flex flex-col gap-6 bg-white/10 text-white/95 p-8 backdrop-blur-2xl border-r border-white/20">
                    <div>
                        <h2 class="text-lg font-semibold tracking-wide drop-shadow">Conversations</h2>
                        <p class="text-sm text-white/70 mt-1">Choose a chat to load messages instantly.</p>
                    </div>

                    <nav class="flex-1 min-h-0 overflow-y-auto pr-1">
                        <ul class="space-y-2">
                            {% if previous_chats %}
                                {% for chat in previous_chats %}
                                    {% set is_active = chat.id == receiver_id %}
                                    <li>
                                        <a
                                            href="{{ url_for('chat.chat', receiver_id=chat.id) }}"
                                            hx-get="{{ url_for('chat.chat', receiver_id=chat.id) }}"
                                            hx-target="#chat-panel"
                                            hx-swap="outerHTML"
                                            hx-push-url="true"
                                            class="group block rounded-2xl border px-4 py-3 transition-all duration-200 backdrop-blur-lg {% if is_active %}bg-white/35 border-white/60 text-slate-900 shadow-lg shadow-white/30{% else %}bg-white/10 border-white/20 text-white/90 hover:bg-white/20 hover:text-white{% endif %}"
                                            aria-current="{{ 'page' if is_active else 'false' }}">
                                            <div class="flex items-center justify-between gap-3">
                                                <div>
                                                    <p class="text-sm font-semibold">{{ chat.first_name or chat.email }}</p>
                                                    <p class="text-xs text-black/70">{{ chat.email }}</p>
                                                </div>
                                                <span class="text-white/60 group-hover:text-white text-lg leading-none">→</span>
                                            </div>
                                        </a>
                                    </li>
                                {% endfor %}
                            {% else %}
                                <li class="rounded-2xl bg-white/10 border border-white/20 p-4 text-sm text-white/70">
                                    No conversations yet. Start by sending a message.
                                </li>
                            {% endif %}
                        </ul>
                    </nav>

                    <div class="text-xs text-black/70">
                        Conversations are moderated to keep our community grounded and welcoming. ✨
                    </div>
                </aside>

                {% include "user/partials/chat_thread.html" %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" nonce="{{ csp_nonce() }}" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/socket.js') }}" nonce="{{ csp_nonce() }}"></script>
{% endblock %}
